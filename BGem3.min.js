var BGem3={};BGem3.Scene=function(t){this.objs=[],this.cams=[],this.bg=t.bg||[142,214,255],this.fog=t.fog||!0,this.fogColor=t.fogColor||t.bg||[142,214,255],this.fogDist=800},BGem3.Camera=function(t){this.position=t.pos||[0,0,0],this.rotation=t.rot||[0,0,0],this.focalLen=t.fl||800,this.friction=t.fr||.2,this.speed=t.speed||1,this.w=0,this.a=0,this.s=0,this.d=0,this.u=0,this.o=0,this.l=0,this.r=0},BGem3.Obj3D=function(t){this.mesh=t,this.visible=!0,this.stroke=!1,this.fill=!1,this.textured=!1},BGem3.Mesh=function(){this.rotation=[0,0,0],this.rotation=[0,0,0],this.vertices3D=[],this.vertices2D=[],this.transform=[],this.faces=[]},BGem3.CubeMesh=function(t){BGem3.Mesh.apply(this,arguments),this.size=t.size||5,this.rotation=t.rot||[0,0,0],this.position=t.pos||[0,0,0],this.color=t.color||[102,45,145],this.textured=t.textured||!1,this.shine=!0,this.shadow=!0,this.shineWidth=1.2,this.shineStren=50,this.vertices3D=[[0,0,0],[this.size,-this.size,-this.size],[-this.size,-this.size,-this.size],[-this.size,this.size,-this.size],[this.size,this.size,-this.size],[this.size,-this.size,this.size],[-this.size,-this.size,this.size],[-this.size,this.size,this.size],[this.size,this.size,this.size]],this.faces=[[1,2,3,4],[5,1,4,8],[6,5,8,7],[2,6,7,3],[5,6,2,1],[4,3,7,8]]},BGem3.CubeMesh.prototype=new BGem3.Mesh,BGem3.Renderer=function(t,s){this.fps=s.fps,this.interval=1/this.fps*1e3,this.maxWidth=s.maxWidth,this.maxHeight=s.maxHeight,this.centerX=s.maxWidth/2,this.centerY=s.maxHeight/2,this.ctx=s.ctx,this.texture=s.texture;var e=t,a=this;this.camera=e.cams[0],this.render=function(){$({}).queue(a.tasks.make_transform).queue(a.tasks.interpret_cam).queue(a.tasks.translate_scene).queue(a.tasks.project2d).queue(a.tasks.z_sort).queue(a.tasks.draw)},this.tasks={make_transform:function(t){for(var s=0;s<e.objs.length;s++)e.objs[s].mesh.transform=JSON.parse(JSON.stringify(e.objs[s].mesh.vertices3D));t()},interpret_cam:function(t){var s=a.camera,e=s.friction,r=s.rotation[1];s.w>0&&(s.position[2]+=Math.cos(Maths.radians(r))*s.w,s.position[0]-=Math.sin(Maths.radians(r))*s.w,s.w<1&&(s.w-=e)),s.s>0&&(s.position[2]-=Math.cos(Maths.radians(r))*s.s,s.position[0]+=Math.sin(Maths.radians(r))*s.s,s.s<1&&(s.s-=e)),s.a>0&&(s.position[2]-=Math.sin(Maths.radians(r))*s.a,s.position[0]-=Math.cos(Maths.radians(r))*s.a,s.a<1&&(s.a-=e)),s.d>0&&(s.position[2]+=Math.sin(Maths.radians(r))*s.d,s.position[0]+=Math.cos(Maths.radians(r))*s.d,s.d<1&&(s.d-=e)),s.u>0&&(s.rotation[0]+=s.u,s.u<1&&(s.u-=e)),s.o>0&&(s.rotation[0]-=s.o,s.o<1&&(s.o-=e)),s.l>0&&(s.rotation[1]+=s.l,s.l<1&&(s.l-=e)),s.r>0&&(s.rotation[1]-=s.r,s.r<1&&(s.r-=e)),t()},translate_scene:function(t){for(var s=0;s<e.objs.length;s++){var r=e.objs[s].mesh.transform.slice();e.objs[s].mesh.transform=Maths.rotate(r,e.objs[s].mesh.rotation),e.objs[s].mesh.transform=Maths.translate(r,e.objs[s].mesh.position),e.objs[s].mesh.transform=Maths.translate(r,a.camera.position),e.objs[s].mesh.transform=Maths.rotate(r,a.camera.rotation)}t()},project2d:function(s){for(var r=0;r<e.objs.length;r++)for(var o=0;o<e.objs[r].mesh.transform.length;o++){if(t.objs[r].mesh.transform[o][2]>=0)var i=a.camera.focalLen*-t.objs[r].mesh.transform[o][2];else var i=a.camera.focalLen/t.objs[r].mesh.transform[o][2];var h=Maths.round2(t.objs[r].mesh.transform[o][0]*i+a.centerX),n=Maths.round2(t.objs[r].mesh.transform[o][1]*i+a.centerY);e.objs[r].mesh.vertices2D.push([h,n])}s()},z_sort:function(t){a.zSort=[];for(var s=0;s<e.objs.length;s++){for(var r=0;r<e.objs[s].mesh.faces.length;r++){for(var o=0,i=[],h=0;h<e.objs[s].mesh.faces[r].length;h++){var n=e.objs[s].mesh.faces[r][h];o+=e.objs[s].mesh.transform[n][2],i.push(e.objs[s].mesh.vertices2D[n])}i.push(o),-50>o?i.push(!0):i.push(!1);var c=[e.objs[s].mesh.transform[e.objs[s].mesh.faces[r][0]],e.objs[s].mesh.transform[e.objs[s].mesh.faces[r][1]],e.objs[s].mesh.transform[e.objs[s].mesh.faces[r][2]]],f=Maths.get_normal(c),m={color:e.objs[s].mesh.color,shine:e.objs[s].mesh.shine,shadow:e.objs[s].mesh.shadow,shineWidth:e.objs[s].mesh.shineWidth,shineStren:e.objs[s].mesh.shineStren,normal:f,textured:e.objs[s].mesh.textured};i.push(m),a.zSort.push(i)}e.objs[s].mesh.transform=[],e.objs[s].mesh.vertices2D=[]}a.zSort.sort(function(t,s){return t[4]-s[4]}),t()},draw:function(){var t=a.ctx;t.clearRect(0,0,a.maxWidth,a.maxHeight),t.fillStyle="rgb("+e.bg[0]+","+e.bg[1]+","+e.bg[2]+")",t.fillRect(0,0,a.maxWidth,a.maxHeight);for(var s=0;s<a.zSort.length;s++)if(a.zSort[s][5]&&(a.zSort[s][5]=Maths.backface_cull(a.zSort[s]),a.zSort[s][5])){var r=[a.zSort[s][0],a.zSort[s][1],a.zSort[s][2],a.zSort[s][3]];t.beginPath(),t.moveTo(r[0][0],r[0][1]),t.lineTo(r[1][0],r[1][1]),t.lineTo(r[2][0],r[2][1]),t.lineTo(r[3][0],r[3][1]),t.lineTo(r[0][0],r[0][1]),t.closePath();var o=a.zSort[s][6].color,i=o[0],h=o[1],n=o[2];if(a.zSort[s][6].shadow){var c=a.zSort[s][6].normal,f=a.zSort[s][6].shineWidth,m=a.zSort[s][6].shineStren,l=1-c/Math.PI,u=1-c/Math.PI*f;if(i=Math.floor(o[0]*l)+Math.floor(o[0]*u+m*u),h=Math.floor(o[1]*l)+Math.floor(o[1]*u+m*u),n=Math.floor(o[2]*l)+Math.floor(o[2]*u+m*u),e.fog){var M=-a.zSort[s][4]/4,b=M/e.fogDist;b>1&&(b=1);var d=i-e.fogColor[0];i=Math.floor(i-d*b);var g=h-e.fogColor[1];h=Math.floor(h-g*b);var v=n-e.fogColor[2];n=Math.floor(n-v*b)}}t.strokeStyle="rgb("+i+","+h+","+n+")",t.stroke(),t.fillStyle="rgb("+i+","+h+","+n+")",t.fill(),a.zSort[s][6].stroke&&(t.strokeStyle="rgb(0,0,0)",t.stroke()),t.restore()}a.zSort=[]}}},BGem3.Controller=function(t,s){var e=s;this.init=function(){var t=e.camera,s=t.speed,a=t.friction;$(window).bind({keydown:function(e){switch(e.keyCode){case 87:t.w=s;break;case 65:t.a=s;break;case 83:t.s=s;break;case 68:t.d=s;break;case 38:t.u=s;break;case 40:t.o=s;break;case 37:t.l=s;break;case 39:t.r=s}},keyup:function(s){switch(s.keyCode){case 87:t.w-=a;break;case 65:t.a-=a;break;case 83:t.s-=a;break;case 68:t.d-=a;break;case 38:t.u=0;break;case 40:t.o=0;break;case 37:t.l=0;break;case 39:t.r=0}}})}},BGem3.Maths=function(){this.translate=function(t,s){for(var e=0;e<t.length;e++)t[e][0]+=s[0],t[e][1]+=s[1],t[e][2]+=s[2];return t},this.rotate=function(t,s){for(var e=0;e<t.length;e++){var a=t[e][0],r=t[e][2],o=Maths.get_angle([0,0],[a,r]),i=o-Maths.radians(s[1]);i>2*Math.PI&&(i-=2*Math.PI);var h=Maths.get_dist([0,0],[a,r]);t[e][0]=Math.cos(i)*h,t[e][2]=Math.sin(i)*h}for(var n=0;n<t.length;n++){var a=t[n][0],c=t[n][1],o=Maths.get_angle([0,0],[a,c]),i=o-Maths.radians(s[2]);i>2*Math.PI&&(i-=2*Math.PI);var h=Maths.get_dist([0,0],[a,c]);t[n][0]=Math.cos(i)*h,t[n][1]=Math.sin(i)*h}for(var f=0;f<t.length;f++){var c=t[f][1],r=t[f][2],o=Maths.get_angle([0,0],[c,r]),i=o-Maths.radians(s[0]);i>2*Math.PI&&(i-=2*Math.PI);var h=Maths.get_dist([0,0],[c,r]);t[f][1]=Math.cos(i)*h,t[f][2]=Math.sin(i)*h}return t},this.radians=function(t){return t*Math.PI/180},this.get_angle=function(t,s){var e,a=t[0],r=s[0],o=t[1],i=s[1];return r>a&&i>=o?e=Math.atan((i-o)/(r-a)):a>=r&&i>o?e=.5*Math.PI-Math.atan((r-a)/(i-o)):a>r&&o>=i?e=Math.PI+Math.atan((i-o)/(r-a)):r>=a&&o>i&&(e=1.5*Math.PI-Math.atan((r-a)/(i-o))),e},this.get_dist=function(t,s){var e=t[0]-s[0],a=t[1]-s[1],r=Math.sqrt(e*e+a*a);return r},this.random=function(t,s){var e=s-t;return Math.floor(Math.random()*e+t)},this.round2=function(t){return Math.round(100*(t+1e-5))/100},this.backface_cull=function(t){var s=t[0],e=t[1],a=t[2],r=e[0]-s[0],o=e[1]-s[1],i=e[0]-a[0],h=e[1]-a[1],n=r*h-o*i;return 0>n?!0:!1},this.get_normal=function(t){var s=[100,200,50],e=t[0],a=t[1],r=t[2],o=a[0]-e[0],i=a[1]-e[1],h=a[2]-e[2],n=r[0]-e[0],c=r[1]-e[1],f=a[2]-e[2],m=i*f-h*c,l=h*n-o*f,u=o*c-i*n,M=m,b=l,d=u,g=s[0],v=s[1],z=s[2],j=Math.acos((M*g+b*v+d*z)/Math.sqrt((M*M+b*b+d*d)*(g*g+v*v+z*z)));return j}};var Maths=new BGem3.Maths;