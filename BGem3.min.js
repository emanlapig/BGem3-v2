function r_texture(a,b,c){for(var d=[[0,1,3],[1,2,3]],e=[[0,640],[640,640],[640,0],[0,0]],f=0;f<d.length;f++){a.save(),a.beginPath(),a.moveTo(b[0][0],b[0][1]),a.lineTo(b[1][0],b[1][1]),a.lineTo(b[2][0],b[2][1]),a.lineTo(b[3][0],b[3][1]),a.lineTo(b[0][0],b[0][1]),a.closePath(),a.clip();var g=d[f],h=g[0],i=g[1],j=g[2],k=b[h][0],l=b[i][0],m=b[j][0],n=b[h][1],o=b[i][1],p=b[j][1],q=e[h][0],r=e[i][0],s=e[j][0],t=e[h][1],u=e[i][1],v=e[j][1],w=q*u+t*s+r*v-u*s-t*r-q*v,x=k*u+t*m+l*v-u*m-t*l-k*v,y=q*l+k*s+r*m-l*s-k*r-q*m,z=q*u*m+t*l*s+k*r*v-k*u*s-t*r*m-q*l*v,A=n*u+t*p+o*v-u*p-t*o-n*v,B=q*o+n*s+r*p-o*s-n*r-q*p,C=q*u*p+t*o*s+n*r*v-n*u*s-t*r*p-q*o*v;a.transform(x/w,A/w,y/w,B/w,z/w,C/w),a.drawImage(c.texture,0,0),a.restore()}}function r_draw_bg(a,b,c){var d=a.ctx,e=b.createLinearGradient(0,-maxHeight,0,2*maxHeight),f=c.rot[0]+90,g=f/175;d.save(),d.clearRect(0,0,maxWidth,2*maxHeight),e.addColorStop(.2,"rgb("+a.top[0]+","+a.top[1]+","+a.top[2]+")"),e.addColorStop(Math.max(Math.min(g-.01,.8),.2),"rgb("+a.sky[0]+","+a.sky[1]+","+a.sky[2]+")"),e.addColorStop(Math.max(Math.min(g+.01,.8),.2),"rgb("+a.ground[0]+","+a.ground[1]+","+a.ground[2]+")"),e.addColorStop(.8,"rgb("+a.btm[0]+","+a.btm[1]+","+a.btm[2]+")"),d.fillStyle=e,d.fillRect(0,-maxHeight,maxWidth,2*maxHeight),b.drawImage(a.can,0,0),b.restore(),d.restore()}function translate(a,b){for(var c=0;c<a.length;c++)a[c][0]+=b[0],a[c][1]+=b[1],a[c][2]+=b[2];return a}function rotate(a,b){for(var c=0;c<a.length;c++){var d=a[c][0],e=a[c][2],f=get_angle([0,0],[d,e]),g=f-radians(b[1]);g>2*Math.PI&&(g-=2*Math.PI);var h=get_dist([0,0],[d,e]);a[c][0]=Math.cos(g)*h,a[c][2]=Math.sin(g)*h}for(var i=0;i<a.length;i++){var d=a[i][0],j=a[i][1],f=get_angle([0,0],[d,j]),g=f-radians(b[2]);g>2*Math.PI&&(g-=2*Math.PI);var h=get_dist([0,0],[d,j]);a[i][0]=Math.cos(g)*h,a[i][1]=Math.sin(g)*h}for(var k=0;k<a.length;k++){var j=a[k][1],e=a[k][2],f=get_angle([0,0],[j,e]),g=f-radians(b[0]);g>2*Math.PI&&(g-=2*Math.PI);var h=get_dist([0,0],[j,e]);a[k][1]=Math.cos(g)*h,a[k][2]=Math.sin(g)*h}return a}function radians(a){return a*Math.PI/180}function get_angle(a,b){var c,d=a[0],e=b[0],f=a[1],g=b[1];return e>d&&g>=f?c=Math.atan((g-f)/(e-d)):e<=d&&g>f?c=.5*Math.PI-Math.atan((e-d)/(g-f)):e<d&&g<=f?c=Math.PI+Math.atan((g-f)/(e-d)):e>=d&&g<f&&(c=1.5*Math.PI-Math.atan((e-d)/(g-f))),c}function get_dist(a,b){var c=a[0]-b[0],d=a[1]-b[1],e=Math.sqrt(c*c+d*d);return e}function random(a,b){var c=b-a;return Math.floor(Math.random()*c+a)}function round2(a){return Math.round(100*(a+1e-5))/100}function backface_cull(a){var b=a[0],c=a[1],d=a[2],e=c[0]-b[0],f=c[1]-b[1],g=c[0]-d[0],h=c[1]-d[1],i=e*h-f*g;return i<0}function get_normal(a){var b=[100,200,50],c=a[0],d=a[1],e=a[2],f=d[0]-c[0],g=d[1]-c[1],h=d[2]-c[2],i=e[0]-c[0],j=e[1]-c[1],k=d[2]-c[2],l=g*k-h*j,m=h*i-f*k,n=f*j-g*i,o=l,p=m,q=n,r=b[0],s=b[1],t=b[2],u=Math.acos((o*r+p*s+q*t)/Math.sqrt((o*o+p*p+q*q)*(r*r+s*s+t*t)));return u}var Scene=function(){this.objs=[],this.cams=[],this.fog=!0,this.fogColor=[142,214,255],this.fogDist=600,this.clipDist=50},Camera=function(a){this.pos=a.pos||[0,0,0],this.rot=a.rot||[0,0,0],this.focalLen=a.fl||800,this.friction=a.fr||.2,this.speed=a.speed||1,this.w=0,this.a=0,this.s=0,this.d=0,this.u=0,this.o=0,this.l=0,this.r=0},Renderer=function(a,b){this.fps=b.fps,this.interval=1/this.fps*1e3,this.maxWidth=b.maxWidth,this.maxHeight=b.maxHeight,this.centerX=b.maxWidth/2,this.centerY=b.maxHeight/2,this.ctx=b.ctx,this.texture=b.texture,this.bg=b.bg;var c=a,d=this;this.camera=c.cams[0],this.queue=["make_transform","interpret_cam","translate_scene","project2d","z_sort","draw"],this.render=function(){this.queue.forEach(function(a){d.tasks[a]()})},this.tasks={make_transform:function(){for(var a=0;a<c.objs.length;a++)c.objs[a].mesh.transform=JSON.parse(JSON.stringify(c.objs[a].mesh.vertices3D))},interpret_cam:function(){var a=d.camera,b=a.friction,c=a.rot[1];a.w>0&&(a.pos[2]+=Math.cos(radians(c))*a.w,a.pos[0]-=Math.sin(radians(c))*a.w,a.w<1&&(a.w-=b)),a.s>0&&(a.pos[2]-=Math.cos(radians(c))*a.s,a.pos[0]+=Math.sin(radians(c))*a.s,a.s<1&&(a.s-=b)),a.a>0&&(a.pos[2]-=Math.sin(radians(c))*a.a,a.pos[0]-=Math.cos(radians(c))*a.a,a.a<1&&(a.a-=b)),a.d>0&&(a.pos[2]+=Math.sin(radians(c))*a.d,a.pos[0]+=Math.cos(radians(c))*a.d,a.d<1&&(a.d-=b)),a.u>0&&(a.rot[0]+=a.u,a.u<1&&(a.u-=b)),a.o>0&&(a.rot[0]-=a.o,a.o<1&&(a.o-=b)),a.l>0&&(a.rot[1]+=a.l,a.l<1&&(a.l-=b)),a.r>0&&(a.rot[1]-=a.r,a.r<1&&(a.r-=b))},translate_scene:function(){for(var a=0;a<c.objs.length;a++){var b=c.objs[a].mesh.transform.slice();c.objs[a].mesh.transform=rotate(b,c.objs[a].mesh.rot),c.objs[a].mesh.transform=translate(b,c.objs[a].mesh.pos),c.objs[a].mesh.transform=translate(b,d.camera.pos),c.objs[a].mesh.transform=rotate(b,d.camera.rot)}},project2d:function(){for(var b=0;b<c.objs.length;b++)for(var e=0;e<c.objs[b].mesh.transform.length;e++){if(a.objs[b].mesh.transform[e][2]>=0)var f=d.camera.focalLen*-a.objs[b].mesh.transform[e][2];else var f=d.camera.focalLen/a.objs[b].mesh.transform[e][2];var g=round2(a.objs[b].mesh.transform[e][0]*f+d.centerX),h=round2(a.objs[b].mesh.transform[e][1]*f+d.centerY);c.objs[b].mesh.vertices2D.push([g,h])}},z_sort:function(){d.zSort=[];for(var a=0;a<c.objs.length;a++){for(var b=0;b<c.objs[a].mesh.faces.length;b++){for(var e=0,f=[],g=0;g<c.objs[a].mesh.faces[b].length;g++){var h=c.objs[a].mesh.faces[b][g];e+=c.objs[a].mesh.transform[h][2],f.push(c.objs[a].mesh.vertices2D[h])}f.push(e),e<-c.clipDist?f.push(!0):f.push(!1);var i=[c.objs[a].mesh.transform[c.objs[a].mesh.faces[b][0]],c.objs[a].mesh.transform[c.objs[a].mesh.faces[b][1]],c.objs[a].mesh.transform[c.objs[a].mesh.faces[b][2]]],j=get_normal(i),k={color:c.objs[a].mesh.color,shine:c.objs[a].mesh.shine,shadow:c.objs[a].mesh.shadow,shineWidth:c.objs[a].mesh.shineWidth,shineStren:c.objs[a].mesh.shineStren,normal:j,textured:c.objs[a].mesh.textured,fill:c.objs[a].mesh.fill,stroke:c.objs[a].mesh.stroke};f.push(k),d.zSort.push(f)}c.objs[a].mesh.transform=[],c.objs[a].mesh.vertices2D=[]}d.zSort.sort(function(a,b){return a[4]-b[4]})},draw:function(){var a=d.ctx;a.clearRect(0,0,d.maxWidth,d.maxHeight),d.bg?r_draw_bg(d.bg,a,d.camera):(a.fillStyle="rgb(142, 214, 255)",a.fillRect(0,0,d.maxWidth,d.maxHeight));for(var b=0;b<d.zSort.length;b++)if(d.zSort[b][5]&&(d.zSort[b][5]=backface_cull(d.zSort[b]),d.zSort[b][5])){var e=[d.zSort[b][0],d.zSort[b][1],d.zSort[b][2],d.zSort[b][3]];a.beginPath(),a.moveTo(e[0][0],e[0][1]),a.lineTo(e[1][0],e[1][1]),a.lineTo(e[2][0],e[2][1]),a.lineTo(e[3][0],e[3][1]),a.lineTo(e[0][0],e[0][1]),a.closePath();var f=d.zSort[b][6].color,g=f[0],h=f[1],i=f[2];if(d.zSort[b][6].shadow){var j=d.zSort[b][6].normal,k=d.zSort[b][6].shineWidth,l=d.zSort[b][6].shineStren,m=1-j/Math.PI,n=1-j/Math.PI*k;if(g=Math.floor(f[0]*m)+Math.floor(f[0]*n+l*n),h=Math.floor(f[1]*m)+Math.floor(f[1]*n+l*n),i=Math.floor(f[2]*m)+Math.floor(f[2]*n+l*n),c.fog){var o=-d.zSort[b][4]/4,p=o/c.fogDist;p>1&&(p=1);var q=g-c.fogColor[0];g=Math.floor(g-q*p);var r=h-c.fogColor[1];h=Math.floor(h-r*p);var s=i-c.fogColor[2];i=Math.floor(i-s*p)}}d.zSort[b][6].fill&&(a.fillStyle="rgb("+g+","+h+","+i+")",a.fill()),d.zSort[b][6].stroke&&(a.strokeStyle="rgb("+g+","+h+","+i+")",a.stroke()),d.zSort[b][6].textured&&r_texture(a,e,d),a.restore()}d.zSort=[]}}},Controller=function(a){this.init=function(){var b=a.camera,c=b.speed,d=b.friction;window.addEventListener("keydown",function(a){switch(a.keyCode){case 87:b.w=c;break;case 65:b.a=c;break;case 83:b.s=c;break;case 68:b.d=c;break;case 38:b.u=c;break;case 40:b.o=c;break;case 37:b.l=c;break;case 39:b.r=c}}),window.addEventListener("keyup",function(a){switch(a.keyCode){case 87:b.w-=d;break;case 65:b.a-=d;break;case 83:b.s-=d;break;case 68:b.d-=d;break;case 38:b.u=0;break;case 40:b.o=0;break;case 37:b.l=0;break;case 39:b.r=0}})}};