var BGem3={};BGem3.Scene=function(a){this.objs=[],this.cams=[],this.bg=a.bg||[142,214,255],this.fog=void 0!==a.fog||a.fog,this.fogColor=a.fogColor||a.bg||[142,214,255],this.fogDist=800,this.clipDist=50},BGem3.Camera=function(a){this.position=a.pos||[0,0,0],this.rotation=a.rot||[0,0,0],this.focalLen=a.fl||800,this.friction=a.fr||.2,this.speed=a.speed||1,this.w=0,this.a=0,this.s=0,this.d=0,this.u=0,this.o=0,this.l=0,this.r=0},BGem3.Obj3D=function(a){this.mesh=a,this.visible=!0},BGem3.Mesh=function(){this.rotation=[0,0,0],this.rotation=[0,0,0],this.vertices3D=[],this.vertices2D=[],this.transform=[],this.faces=[],this.fill=!1,this.stroke=!0},BGem3.CubeMesh=function(a){BGem3.Mesh.apply(this,arguments),this.size=a.size||5,this.rotation=a.rot||[0,0,0],this.position=a.pos||[0,0,0],this.color=a.color||[102,45,145],this.textured=void 0===a.textured&&a.textured,this.fill=void 0!==a.fill||a.fill,this.stroke=void 0!==a.stroke||a.stroke,this.shine=void 0!==a.shine||a.shine,this.shadow=void 0!==a.shadow||a.shadow,this.shineWidth=1.2,this.shineStren=50,this.vertices3D=[[0,0,0],[this.size,-this.size,-this.size],[-this.size,-this.size,-this.size],[-this.size,this.size,-this.size],[this.size,this.size,-this.size],[this.size,-this.size,this.size],[-this.size,-this.size,this.size],[-this.size,this.size,this.size],[this.size,this.size,this.size]],this.faces=[[1,2,3,4],[5,1,4,8],[6,5,8,7],[2,6,7,3],[5,6,2,1],[4,3,7,8]]},BGem3.CubeMesh.prototype=new BGem3.Mesh,BGem3.Renderer=function(a,b){this.fps=b.fps,this.interval=1/this.fps*1e3,this.maxWidth=b.maxWidth,this.maxHeight=b.maxHeight,this.centerX=b.maxWidth/2,this.centerY=b.maxHeight/2,this.ctx=b.ctx,this.texture=b.texture;var c=a,d=this;this.camera=c.cams[0],this.queue=["make_transform","interpret_cam","translate_scene","project2d","z_sort","draw"],this.render=function(){this.queue.forEach(function(a){d.tasks[a]()})},this.tasks={make_transform:function(){for(var a=0;a<c.objs.length;a++)c.objs[a].mesh.transform=JSON.parse(JSON.stringify(c.objs[a].mesh.vertices3D))},interpret_cam:function(){var a=d.camera,b=a.friction,c=a.rotation[1];a.w>0&&(a.position[2]+=Math.cos(Maths.radians(c))*a.w,a.position[0]-=Math.sin(Maths.radians(c))*a.w,a.w<1&&(a.w-=b)),a.s>0&&(a.position[2]-=Math.cos(Maths.radians(c))*a.s,a.position[0]+=Math.sin(Maths.radians(c))*a.s,a.s<1&&(a.s-=b)),a.a>0&&(a.position[2]-=Math.sin(Maths.radians(c))*a.a,a.position[0]-=Math.cos(Maths.radians(c))*a.a,a.a<1&&(a.a-=b)),a.d>0&&(a.position[2]+=Math.sin(Maths.radians(c))*a.d,a.position[0]+=Math.cos(Maths.radians(c))*a.d,a.d<1&&(a.d-=b)),a.u>0&&(a.rotation[0]+=a.u,a.u<1&&(a.u-=b)),a.o>0&&(a.rotation[0]-=a.o,a.o<1&&(a.o-=b)),a.l>0&&(a.rotation[1]+=a.l,a.l<1&&(a.l-=b)),a.r>0&&(a.rotation[1]-=a.r,a.r<1&&(a.r-=b))},translate_scene:function(){for(var a=0;a<c.objs.length;a++){var b=c.objs[a].mesh.transform.slice();c.objs[a].mesh.transform=Maths.rotate(b,c.objs[a].mesh.rotation),c.objs[a].mesh.transform=Maths.translate(b,c.objs[a].mesh.position),c.objs[a].mesh.transform=Maths.translate(b,d.camera.position),c.objs[a].mesh.transform=Maths.rotate(b,d.camera.rotation)}},project2d:function(){for(var b=0;b<c.objs.length;b++)for(var e=0;e<c.objs[b].mesh.transform.length;e++){if(a.objs[b].mesh.transform[e][2]>=0)var f=d.camera.focalLen*-a.objs[b].mesh.transform[e][2];else var f=d.camera.focalLen/a.objs[b].mesh.transform[e][2];var g=Maths.round2(a.objs[b].mesh.transform[e][0]*f+d.centerX),h=Maths.round2(a.objs[b].mesh.transform[e][1]*f+d.centerY);c.objs[b].mesh.vertices2D.push([g,h])}},z_sort:function(){d.zSort=[];for(var a=0;a<c.objs.length;a++){for(var b=0;b<c.objs[a].mesh.faces.length;b++){for(var e=0,f=[],g=0;g<c.objs[a].mesh.faces[b].length;g++){var h=c.objs[a].mesh.faces[b][g];e+=c.objs[a].mesh.transform[h][2],f.push(c.objs[a].mesh.vertices2D[h])}f.push(e),e<-c.clipDist?f.push(!0):f.push(!1);var i=[c.objs[a].mesh.transform[c.objs[a].mesh.faces[b][0]],c.objs[a].mesh.transform[c.objs[a].mesh.faces[b][1]],c.objs[a].mesh.transform[c.objs[a].mesh.faces[b][2]]],j=Maths.get_normal(i),k={color:c.objs[a].mesh.color,shine:c.objs[a].mesh.shine,shadow:c.objs[a].mesh.shadow,shineWidth:c.objs[a].mesh.shineWidth,shineStren:c.objs[a].mesh.shineStren,normal:j,textured:c.objs[a].mesh.textured,fill:c.objs[a].mesh.fill,stroke:c.objs[a].mesh.stroke};f.push(k),d.zSort.push(f)}c.objs[a].mesh.transform=[],c.objs[a].mesh.vertices2D=[]}d.zSort.sort(function(a,b){return a[4]-b[4]})},draw:function(){var a=d.ctx;a.clearRect(0,0,d.maxWidth,d.maxHeight),a.fillStyle="rgb("+c.bg[0]+","+c.bg[1]+","+c.bg[2]+")",a.fillRect(0,0,d.maxWidth,d.maxHeight);for(var b=0;b<d.zSort.length;b++)if(d.zSort[b][5]&&(d.zSort[b][5]=Maths.backface_cull(d.zSort[b]),d.zSort[b][5])){var e=[d.zSort[b][0],d.zSort[b][1],d.zSort[b][2],d.zSort[b][3]];a.beginPath(),a.moveTo(e[0][0],e[0][1]),a.lineTo(e[1][0],e[1][1]),a.lineTo(e[2][0],e[2][1]),a.lineTo(e[3][0],e[3][1]),a.lineTo(e[0][0],e[0][1]),a.closePath();var f=d.zSort[b][6].color,g=f[0],h=f[1],i=f[2];if(d.zSort[b][6].shadow){var j=d.zSort[b][6].normal,k=d.zSort[b][6].shineWidth,l=d.zSort[b][6].shineStren,m=1-j/Math.PI,n=1-j/Math.PI*k;if(g=Math.floor(f[0]*m)+Math.floor(f[0]*n+l*n),h=Math.floor(f[1]*m)+Math.floor(f[1]*n+l*n),i=Math.floor(f[2]*m)+Math.floor(f[2]*n+l*n),c.fog){var o=-d.zSort[b][4]/4,p=o/c.fogDist;p>1&&(p=1);var q=g-c.fogColor[0];g=Math.floor(g-q*p);var r=h-c.fogColor[1];h=Math.floor(h-r*p);var s=i-c.fogColor[2];i=Math.floor(i-s*p)}}d.zSort[b][6].fill&&(a.fillStyle="rgb("+g+","+h+","+i+")",a.fill()),d.zSort[b][6].stroke&&(a.strokeStyle="rgb("+g+","+h+","+i+")",a.stroke()),a.restore()}d.zSort=[]}}},BGem3.Controller=function(a,b){var c=b;this.init=function(){var a=c.camera,b=a.speed,d=a.friction;window.addEventListener("keydown",function(c){switch(c.keyCode){case 87:a.w=b;break;case 65:a.a=b;break;case 83:a.s=b;break;case 68:a.d=b;break;case 38:a.u=b;break;case 40:a.o=b;break;case 37:a.l=b;break;case 39:a.r=b}}),window.addEventListener("keyup",function(b){switch(b.keyCode){case 87:a.w-=d;break;case 65:a.a-=d;break;case 83:a.s-=d;break;case 68:a.d-=d;break;case 38:a.u=0;break;case 40:a.o=0;break;case 37:a.l=0;break;case 39:a.r=0}})}},BGem3.Maths=function(){this.translate=function(a,b){for(var c=0;c<a.length;c++)a[c][0]+=b[0],a[c][1]+=b[1],a[c][2]+=b[2];return a},this.rotate=function(a,b){for(var c=0;c<a.length;c++){var d=a[c][0],e=a[c][2],f=Maths.get_angle([0,0],[d,e]),g=f-Maths.radians(b[1]);g>2*Math.PI&&(g-=2*Math.PI);var h=Maths.get_dist([0,0],[d,e]);a[c][0]=Math.cos(g)*h,a[c][2]=Math.sin(g)*h}for(var i=0;i<a.length;i++){var d=a[i][0],j=a[i][1],f=Maths.get_angle([0,0],[d,j]),g=f-Maths.radians(b[2]);g>2*Math.PI&&(g-=2*Math.PI);var h=Maths.get_dist([0,0],[d,j]);a[i][0]=Math.cos(g)*h,a[i][1]=Math.sin(g)*h}for(var k=0;k<a.length;k++){var j=a[k][1],e=a[k][2],f=Maths.get_angle([0,0],[j,e]),g=f-Maths.radians(b[0]);g>2*Math.PI&&(g-=2*Math.PI);var h=Maths.get_dist([0,0],[j,e]);a[k][1]=Math.cos(g)*h,a[k][2]=Math.sin(g)*h}return a},this.radians=function(a){return a*Math.PI/180},this.get_angle=function(a,b){var c,d=a[0],e=b[0],f=a[1],g=b[1];return e>d&&g>=f?c=Math.atan((g-f)/(e-d)):e<=d&&g>f?c=.5*Math.PI-Math.atan((e-d)/(g-f)):e<d&&g<=f?c=Math.PI+Math.atan((g-f)/(e-d)):e>=d&&g<f&&(c=1.5*Math.PI-Math.atan((e-d)/(g-f))),c},this.get_dist=function(a,b){var c=a[0]-b[0],d=a[1]-b[1],e=Math.sqrt(c*c+d*d);return e},this.random=function(a,b){var c=b-a;return Math.floor(Math.random()*c+a)},this.round2=function(a){return Math.round(100*(a+1e-5))/100},this.backface_cull=function(a){var b=a[0],c=a[1],d=a[2],e=c[0]-b[0],f=c[1]-b[1],g=c[0]-d[0],h=c[1]-d[1],i=e*h-f*g;return i<0},this.get_normal=function(a){var b=[100,200,50],c=a[0],d=a[1],e=a[2],f=d[0]-c[0],g=d[1]-c[1],h=d[2]-c[2],i=e[0]-c[0],j=e[1]-c[1],k=d[2]-c[2],l=g*k-h*j,m=h*i-f*k,n=f*j-g*i,o=l,p=m,q=n,r=b[0],s=b[1],t=b[2],u=Math.acos((o*r+p*s+q*t)/Math.sqrt((o*o+p*p+q*q)*(r*r+s*s+t*t)));return u}};var Maths=new BGem3.Maths;