var BGem3=BGem3||{};BGem3.Scene=function(){this.objs=[],this.cams=[]},BGem3.Camera=function(s){this.position=s.pos||[0,0,0],this.rotation=s.rot||[0,0,0],this.focalLen=s.fl||800,this.friction=s.fr||.2,this.speed=s.speed||1,this.w=0,this.a=0,this.s=0,this.d=0,this.u=0,this.o=0,this.l=0,this.r=0},BGem3.Obj3D=function(s){this.mesh=s,this.visible=!0,this.stroke=!1,this.fill=!1,this.textured=!1},BGem3.Mesh=function(){this.rotation=[0,0,0],this.rotation=[0,0,0],this.vertices3D=[],this.vertices2D=[],this.transform=[],this.faces=[]},BGem3.CubeMesh=function(s){BGem3.Mesh.apply(this,arguments),this.size=s.size||5,this.rotation=s.rot||[0,0,0],this.position=s.pos||[0,0,0],this.color=s.color||[102,45,145],this.shine=!0,this.shadow=!0,this.shine_width=1.2,this.shine_stren=50,this.vertices3D=[[0,0,0],[this.size,-this.size,-this.size],[-this.size,-this.size,-this.size],[-this.size,this.size,-this.size],[this.size,this.size,-this.size],[this.size,-this.size,this.size],[-this.size,-this.size,this.size],[-this.size,this.size,this.size],[this.size,this.size,this.size]],this.faces=[[1,2,3,4],[5,1,4,8],[6,5,8,7],[2,6,7,3],[5,6,2,1],[4,3,7,8]]},BGem3.CubeMesh.prototype=new BGem3.Mesh,BGem3.Renderer=function(s,t){this.fps=t.fps,this.interval=1/this.fps*1e3,this.maxWidth=t.maxWidth,this.maxHeight=t.maxHeight,this.centerX=t.maxWidth/2,this.centerY=t.maxHeight/2,this.ctx=t.ctx;var a=s,e=this;this.camera=a.cams[0],this.callback_chain=["make_transform","interpret_cam","translate_scene","project2d","z_sort","draw"],this.render=function(){this.callback_chain.forEach(function(s){e.tasks[s]()})},this.tasks={make_transform:function(){for(var s=0;s<a.objs.length;s++)a.objs[s].mesh.transform=JSON.parse(JSON.stringify(a.objs[s].mesh.vertices3D))},interpret_cam:function(){var s=e.camera,t=s.friction,a=s.rotation[1];s.w>0&&(s.position[2]+=Math.cos(Maths.radians(a))*s.w,s.position[0]-=Math.sin(Maths.radians(a))*s.w,s.w<1&&(s.w-=t)),s.s>0&&(s.position[2]-=Math.cos(Maths.radians(a))*s.s,s.position[0]+=Math.sin(Maths.radians(a))*s.s,s.s<1&&(s.s-=t)),s.a>0&&(s.position[2]-=Math.sin(Maths.radians(a))*s.a,s.position[0]-=Math.cos(Maths.radians(a))*s.a,s.a<1&&(s.a-=t)),s.d>0&&(s.position[2]+=Math.sin(Maths.radians(a))*s.d,s.position[0]+=Math.cos(Maths.radians(a))*s.d,s.d<1&&(s.d-=t)),s.u>0&&(s.rotation[0]+=s.u,s.u<1&&(s.u-=t)),s.o>0&&(s.rotation[0]-=s.o,s.o<1&&(s.o-=t)),s.l>0&&(s.rotation[1]+=s.l,s.l<1&&(s.l-=t)),s.r>0&&(s.rotation[1]-=s.r,s.r<1&&(s.r-=t))},translate_scene:function(){for(var s=0;s<a.objs.length;s++){var t=a.objs[s].mesh.transform.slice();a.objs[s].mesh.transform=Maths.rotate(t,a.objs[s].mesh.rotation),a.objs[s].mesh.transform=Maths.translate(t,a.objs[s].mesh.position),a.objs[s].mesh.transform=Maths.translate(t,e.camera.position),a.objs[s].mesh.transform=Maths.rotate(t,e.camera.rotation)}},project2d:function(){for(var t=0;t<a.objs.length;t++)for(var i=0;i<a.objs[t].mesh.transform.length;i++){var r=e.camera.focalLen/s.objs[t].mesh.transform[i][2],o=s.objs[t].mesh.transform[i][0]*r+e.centerX,h=s.objs[t].mesh.transform[i][1]*r+e.centerY;a.objs[t].mesh.vertices2D.push([o,h])}},z_sort:function(){e.zSort=[];for(var s=0;s<a.objs.length;s++){for(var t=0;t<a.objs[s].mesh.faces.length;t++){for(var i=0,r=[],o=0;o<a.objs[s].mesh.faces[t].length;o++){var h=a.objs[s].mesh.faces[t][o];i+=a.objs[s].mesh.transform[h][2],r.push(a.objs[s].mesh.vertices2D[h])}r.push(i),r.push(!0);var n=[a.objs[s].mesh.transform[a.objs[s].mesh.faces[t][0]],a.objs[s].mesh.transform[a.objs[s].mesh.faces[t][1]],a.objs[s].mesh.transform[a.objs[s].mesh.faces[t][2]]],c=Maths.get_normal(n),f={color:a.objs[s].mesh.color,shine:a.objs[s].mesh.shine,shadow:a.objs[s].mesh.shadow,shine_width:a.objs[s].mesh.shine_width,shine_stren:a.objs[s].mesh.shine_stren,normal:c};r.push(f),e.zSort.push(r)}a.objs[s].mesh.transform=[],a.objs[s].mesh.vertices2D=[]}e.zSort.sort(function(s,t){return s[4]-t[4]})},draw:function(){var s=e.ctx;s.clearRect(0,0,e.maxWidth,e.maxHeight);for(var t=0;t<e.zSort.length;t++)if(e.zSort[t][5]=Maths.backface_cull(e.zSort[t]),e.zSort[t][5]){var a=[e.zSort[t][0],e.zSort[t][1],e.zSort[t][2],e.zSort[t][3]];if(s.beginPath(),s.moveTo(a[0][0],a[0][1]),s.lineTo(a[1][0],a[1][1]),s.lineTo(a[2][0],a[2][1]),s.lineTo(a[3][0],a[3][1]),s.lineTo(a[0][0],a[0][1]),s.closePath(),e.zSort[t][6].shadow){var i=e.zSort[t][6].normal,r=e.zSort[t][6].shine_width,o=e.zSort[t][6].shine_stren,h=1-i/Math.PI,n=1-i/Math.PI*r,c=e.zSort[t][6].color,f=Math.floor(c[0]*h)+Math.floor(c[0]*n+o*n),m=Math.floor(c[1]*h)+Math.floor(c[1]*n+o*n),l=Math.floor(c[2]*h)+Math.floor(c[2]*n+o*n);s.strokeStyle="rgb("+f+","+m+","+l+")",s.stroke(),s.fillStyle="rgb("+f+","+m+","+l+")",s.fill()}e.zSort[t][6].stroke&&(s.strokeStyle="rgb(0,0,0)",s.stroke()),s.restore()}e.zSort=[]}}},BGem3.Controller=function(s,t){var a=t;this.init=function(){var s=a.camera,t=s.speed,e=s.friction;$(window).bind({keydown:function(a){switch(a.keyCode){case 87:s.w=t;break;case 65:s.a=t;break;case 83:s.s=t;break;case 68:s.d=t;break;case 38:s.u=t;break;case 40:s.o=t;break;case 37:s.l=t;break;case 39:s.r=t}},keyup:function(t){switch(t.keyCode){case 87:s.w-=e;break;case 65:s.a-=e;break;case 83:s.s-=e;break;case 68:s.d-=e;break;case 38:s.u=0;break;case 40:s.o=0;break;case 37:s.l=0;break;case 39:s.r=0}}})}},BGem3.Maths=function(){this.translate=function(s,t){for(var a=0;a<s.length;a++)s[a][0]+=t[0],s[a][1]+=t[1],s[a][2]+=t[2];return s},this.rotate=function(s,t){for(var a=0;a<s.length;a++){var e=s[a][0],i=s[a][2],r=Maths.get_angle([0,0],[e,i]),o=r-Maths.radians(t[1]);o>2*Math.PI&&(o-=2*Math.PI);var h=Maths.get_dist([0,0],[e,i]);s[a][0]=Math.cos(o)*h,s[a][2]=Math.sin(o)*h}for(var n=0;n<s.length;n++){var e=s[n][0],c=s[n][1],r=Maths.get_angle([0,0],[e,c]),o=r-Maths.radians(t[2]);o>2*Math.PI&&(o-=2*Math.PI);var h=Maths.get_dist([0,0],[e,c]);s[n][0]=Math.cos(o)*h,s[n][1]=Math.sin(o)*h}for(var f=0;f<s.length;f++){var c=s[f][1],i=s[f][2],r=Maths.get_angle([0,0],[c,i]),o=r-Maths.radians(t[0]);o>2*Math.PI&&(o-=2*Math.PI);var h=Maths.get_dist([0,0],[c,i]);s[f][1]=Math.cos(o)*h,s[f][2]=Math.sin(o)*h}return s},this.radians=function(s){return s*Math.PI/180},this.get_angle=function(s,t){var a=s[0],e=t[0],i=s[1],r=t[1];if(e>=a&&r>=i)var o=Math.atan((r-i)/(e-a));else if(a>=e&&r>=i)var o=.5*Math.PI-Math.atan((e-a)/(r-i));else if(a>=e&&i>=r)var o=Math.PI+Math.atan((r-i)/(e-a));else if(e>=a&&i>=r)var o=1.5*Math.PI-Math.atan((e-a)/(r-i));return o},this.get_dist=function(s,t){var a=s[0]-t[0],e=s[1]-t[1],i=Math.sqrt(a*a+e*e);return i},this.random=function(s,t){var a=t-s;return Math.floor(Math.random()*a+s)},this.backface_cull=function(s){var t=s[0],a=s[1],e=s[2],i=a[0]-t[0],r=a[1]-t[1],o=a[0]-e[0],h=a[1]-e[1],n=i*h-r*o;return 0>n?!0:!1},this.get_normal=function(s){var t=[100,200,50],a=s[0],e=s[1],i=s[2],r=e[0]-a[0],o=e[1]-a[1],h=e[2]-a[2],n=i[0]-a[0],c=i[1]-a[1],f=e[2]-a[2],m=o*f-h*c,l=h*n-r*f,M=r*c-o*n,b=m,u=l,d=M,v=t[0],z=t[1],j=t[2],g=Math.acos((b*v+u*z+d*j)/Math.sqrt((b*b+u*u+d*d)*(v*v+z*z+j*j)));return g}};var Maths=new BGem3.Maths;