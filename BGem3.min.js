function r_transform(a,b){for(var c=0;c<a.objs.length;c++)a.objs[c].mesh.transform=JSON.parse(JSON.stringify(a.objs[c].mesh.vertices3D))}function r_cam(a,b){var c=b.camera,d=c.friction,e=c.rot[1];c.w>0&&(c.pos[2]+=Math.cos(radians(e))*c.w,c.pos[0]-=Math.sin(radians(e))*c.w,c.w<1&&(c.w-=d)),c.s>0&&(c.pos[2]-=Math.cos(radians(e))*c.s,c.pos[0]+=Math.sin(radians(e))*c.s,c.s<1&&(c.s-=d)),c.a>0&&(c.pos[2]-=Math.sin(radians(e))*c.a,c.pos[0]-=Math.cos(radians(e))*c.a,c.a<1&&(c.a-=d)),c.d>0&&(c.pos[2]+=Math.sin(radians(e))*c.d,c.pos[0]+=Math.cos(radians(e))*c.d,c.d<1&&(c.d-=d)),c.u>0&&(c.rot[0]<90&&(c.rot[0]+=c.u),c.u<1&&(c.u-=d)),c.o>0&&(c.rot[0]>-90&&(c.rot[0]-=c.o),c.o<1&&(c.o-=d)),c.l>0&&(c.rot[1]+=c.l,c.l<1&&(c.l-=d)),c.r>0&&(c.rot[1]-=c.r,c.r<1&&(c.r-=d))}function r_scene(a,b){for(var c=0;c<a.objs.length;c++){var d=a.objs[c].mesh.transform.slice();a.objs[c].mesh.transform=rotate(d,a.objs[c].mesh.rot),a.objs[c].mesh.transform=translate(d,a.objs[c].mesh.pos),a.objs[c].mesh.transform=translate(d,b.camera.pos),a.objs[c].mesh.transform=rotate(d,b.camera.rot)}}function r_project(a,b){for(var c=0;c<a.objs.length;c++)for(var d=0;d<a.objs[c].mesh.transform.length;d++){if(a.objs[c].mesh.transform[d][2]>=0)var e=b.camera.focalLen*-a.objs[c].mesh.transform[d][2];else var e=b.camera.focalLen/a.objs[c].mesh.transform[d][2];var f=round2(a.objs[c].mesh.transform[d][0]*e+b.centerX),g=round2(a.objs[c].mesh.transform[d][1]*e+b.centerY);a.objs[c].mesh.vertices2D.push([f,g])}}function r_zsort(a,b){b.zSort=[];for(var c=0;c<a.objs.length;c++){for(var d=0;d<a.objs[c].mesh.faces.length;d++){for(var e=0,f=[],g=0;g<a.objs[c].mesh.faces[d].length;g++){var h=a.objs[c].mesh.faces[d][g];e+=a.objs[c].mesh.transform[h][2],f.push(a.objs[c].mesh.vertices2D[h])}f.push(e),e<-a.clipDist?f.push(!0):f.push(!1);var i=[a.objs[c].mesh.transform[a.objs[c].mesh.faces[d][0]],a.objs[c].mesh.transform[a.objs[c].mesh.faces[d][1]],a.objs[c].mesh.transform[a.objs[c].mesh.faces[d][2]]],j=get_normal(i),k={color:a.objs[c].mesh.color,shine:a.objs[c].mesh.shine,shadow:a.objs[c].mesh.shadow,shineWidth:a.objs[c].mesh.shineWidth,shineStren:a.objs[c].mesh.shineStren,normal:j,textured:a.objs[c].mesh.textured,fill:a.objs[c].mesh.fill,stroke:a.objs[c].mesh.stroke};f.push(k),b.zSort.push(f)}a.objs[c].mesh.transform=[],a.objs[c].mesh.vertices2D=[]}b.zSort.sort(function(a,b){return a[4]-b[4]})}function r_draw(a,b){var c=b.ctx;c.clearRect(0,0,b.maxWidth,b.maxHeight),b.bg?r_draw_bg(b.bg,c,b.camera):(c.fillStyle="rgb(142, 214, 255)",c.fillRect(0,0,b.maxWidth,b.maxHeight));for(var d=0;d<b.zSort.length;d++)if(b.zSort[d][5]&&(b.zSort[d][5]=backface_cull(b.zSort[d]),b.zSort[d][5])){var e=[b.zSort[d][0],b.zSort[d][1],b.zSort[d][2],b.zSort[d][3]];c.beginPath(),c.moveTo(e[0][0],e[0][1]),c.lineTo(e[1][0],e[1][1]),c.lineTo(e[2][0],e[2][1]),c.lineTo(e[3][0],e[3][1]),c.lineTo(e[0][0],e[0][1]),c.closePath();var f=b.zSort[d][6].color,g=f[0],h=f[1],i=f[2];if(b.zSort[d][6].shadow){var j=b.zSort[d][6].normal,k=b.zSort[d][6].shineWidth,l=b.zSort[d][6].shineStren,m=1-j/Math.PI,n=1-j/Math.PI*k;if(g=Math.floor(f[0]*m)+Math.floor(f[0]*n+l*n),h=Math.floor(f[1]*m)+Math.floor(f[1]*n+l*n),i=Math.floor(f[2]*m)+Math.floor(f[2]*n+l*n),a.fog){var o=-b.zSort[d][4]/4,p=o/a.fogDist;p>1&&(p=1);var q=g-a.fogColor[0];g=Math.floor(g-q*p);var r=h-a.fogColor[1];h=Math.floor(h-r*p);var s=i-a.fogColor[2];i=Math.floor(i-s*p)}}b.zSort[d][6].fill&&(c.fillStyle="rgb("+g+","+h+","+i+")",c.fill()),b.zSort[d][6].stroke&&(c.strokeStyle="rgb("+g+","+h+","+i+")",c.stroke()),b.zSort[d][6].textured&&r_texture(c,e,b),c.restore()}b.zSort=[]}function r_texture(a,b,c){for(var d=[[0,1,3],[1,2,3]],e=[[0,640],[640,640],[640,0],[0,0]],f=0;f<d.length;f++){a.save(),a.beginPath(),a.moveTo(b[0][0],b[0][1]),a.lineTo(b[1][0],b[1][1]),a.lineTo(b[2][0],b[2][1]),a.lineTo(b[3][0],b[3][1]),a.lineTo(b[0][0],b[0][1]),a.closePath(),a.clip();var g=d[f],h=g[0],i=g[1],j=g[2],k=b[h][0],l=b[i][0],m=b[j][0],n=b[h][1],o=b[i][1],p=b[j][1],q=e[h][0],r=e[i][0],s=e[j][0],t=e[h][1],u=e[i][1],v=e[j][1],w=q*u+t*s+r*v-u*s-t*r-q*v,x=k*u+t*m+l*v-u*m-t*l-k*v,y=q*l+k*s+r*m-l*s-k*r-q*m,z=q*u*m+t*l*s+k*r*v-k*u*s-t*r*m-q*l*v,A=n*u+t*p+o*v-u*p-t*o-n*v,B=q*o+n*s+r*p-o*s-n*r-q*p,C=q*u*p+t*o*s+n*r*v-n*u*s-t*r*p-q*o*v;a.transform(x/w,A/w,y/w,B/w,z/w,C/w),a.drawImage(c.texture,0,0),a.restore()}}function r_draw_bg(a,b,c){var d=a.ctx,e=b.createLinearGradient(0,-maxHeight,0,2*maxHeight),f=c.rot[0]+90,g=f/170;d.save(),d.clearRect(0,0,maxWidth,2*maxHeight),e.addColorStop(.2,"rgb("+a.top[0]+","+a.top[1]+","+a.top[2]+")"),e.addColorStop(Math.max(Math.min(g,.8),.2),"rgb("+a.sky[0]+","+a.sky[1]+","+a.sky[2]+")"),e.addColorStop(Math.max(Math.min(g+.02,.8),.2),"rgb("+a.ground[0]+","+a.ground[1]+","+a.ground[2]+")"),e.addColorStop(.8,"rgb("+a.btm[0]+","+a.btm[1]+","+a.btm[2]+")"),d.fillStyle=e,d.fillRect(0,-maxHeight,maxWidth,2*maxHeight),b.drawImage(a.can,0,0),b.restore(),d.restore()}function translate(a,b){for(var c=0;c<a.length;c++)a[c][0]+=b[0],a[c][1]+=b[1],a[c][2]+=b[2];return a}function rotate(a,b){for(var c=0;c<a.length;c++){var d=a[c][0],e=a[c][2],f=get_angle([0,0],[d,e]),g=f-radians(b[1]);g>2*Math.PI&&(g-=2*Math.PI);var h=get_dist([0,0],[d,e]);a[c][0]=Math.cos(g)*h,a[c][2]=Math.sin(g)*h}for(var i=0;i<a.length;i++){var d=a[i][0],j=a[i][1],f=get_angle([0,0],[d,j]),g=f-radians(b[2]);g>2*Math.PI&&(g-=2*Math.PI);var h=get_dist([0,0],[d,j]);a[i][0]=Math.cos(g)*h,a[i][1]=Math.sin(g)*h}for(var k=0;k<a.length;k++){var j=a[k][1],e=a[k][2],f=get_angle([0,0],[j,e]),g=f-radians(b[0]);g>2*Math.PI&&(g-=2*Math.PI);var h=get_dist([0,0],[j,e]);a[k][1]=Math.cos(g)*h,a[k][2]=Math.sin(g)*h}return a}function radians(a){return a*Math.PI/180}function get_angle(a,b){var c,d=a[0],e=b[0],f=a[1],g=b[1];return e>d&&g>=f?c=Math.atan((g-f)/(e-d)):e<=d&&g>f?c=.5*Math.PI-Math.atan((e-d)/(g-f)):e<d&&g<=f?c=Math.PI+Math.atan((g-f)/(e-d)):e>=d&&g<f&&(c=1.5*Math.PI-Math.atan((e-d)/(g-f))),c}function get_dist(a,b){var c=a[0]-b[0],d=a[1]-b[1],e=Math.sqrt(c*c+d*d);return e}function random(a,b){var c=b-a;return Math.floor(Math.random()*c+a)}function round2(a){return Math.round(100*(a+1e-5))/100}function backface_cull(a){var b=a[0],c=a[1],d=a[2],e=c[0]-b[0],f=c[1]-b[1],g=c[0]-d[0],h=c[1]-d[1],i=e*h-f*g;return i<0}function get_normal(a){var b=[100,200,50],c=a[0],d=a[1],e=a[2],f=d[0]-c[0],g=d[1]-c[1],h=d[2]-c[2],i=e[0]-c[0],j=e[1]-c[1],k=d[2]-c[2],l=g*k-h*j,m=h*i-f*k,n=f*j-g*i,o=l,p=m,q=n,r=b[0],s=b[1],t=b[2],u=Math.acos((o*r+p*s+q*t)/Math.sqrt((o*o+p*p+q*q)*(r*r+s*s+t*t)));return u}var Scene=function(){this.objs=[],this.cams=[],this.fog=!0,this.fogColor=[142,214,255],this.fogDist=600,this.clipDist=50},Camera=function(a){this.pos=a.pos||[0,0,0],this.rot=a.rot||[0,0,0],this.focalLen=a.fl||800,this.friction=a.fr||.2,this.speed=a.speed||1,this.w=0,this.a=0,this.s=0,this.d=0,this.u=0,this.o=0,this.l=0,this.r=0},Obj3D=function(a){this.mesh=a,this.visible=!0,this.life=3},Mesh=function(){this.rot=[0,0,0],this.vertices3D=[],this.vertices2D=[],this.transform=[],this.faces=[],this.fill=!1,this.stroke=!0},PlaneMesh=function(a){Mesh.apply(this,arguments),this.size=a.size||5,this.rot=a.rot||[0,0,0],this.pos=a.pos||[0,0,0],this.color=a.color||[102,45,145],this.textured=void 0!==a.textured&&a.textured,this.fill=void 0===a.fill||a.fill,this.stroke=void 0===a.stroke||a.stroke,this.shine=void 0===a.shine||a.shine,this.shadow=void 0===a.shadow||a.shadow,this.shineWidth=1.2,this.shineStren=50,this.vertices3D=[[0,0,0],[this.size+this.pos[0],-this.size+this.pos[1],0],[-this.size+this.pos[0],-this.size+this.pos[1],0],[-this.size+this.pos[0],this.size+this.pos[1],0],[this.size+this.pos[0],this.size+this.pos[1],0]],this.faces=[[1,2,3,4]]};PlaneMesh.prototype=new Mesh;var CubeMesh=function(a){Mesh.apply(this,arguments),this.size=a.size||5,this.rot=a.rot||[0,0,0],this.pos=a.pos||[0,0,0],this.color=a.color||[102,45,145],this.textured=void 0!==a.textured&&a.textured,this.fill=void 0===a.fill||a.fill,this.stroke=void 0===a.stroke||a.stroke,this.shine=void 0===a.shine||a.shine,this.shadow=void 0===a.shadow||a.shadow,this.shineWidth=1.2,this.shineStren=50,this.vertices3D=[[0,0,0],[this.size+this.pos[0],-this.size+this.pos[1],-this.size+this.pos[2]],[-this.size+this.pos[0],-this.size+this.pos[1],-this.size+this.pos[2]],[-this.size+this.pos[0],this.size+this.pos[1],-this.size+this.pos[2]],[this.size+this.pos[0],this.size+this.pos[1],-this.size+this.pos[2]],[this.size+this.pos[0],-this.size+this.pos[1],this.size+this.pos[2]],[-this.size+this.pos[0],-this.size+this.pos[1],this.size+this.pos[2]],[-this.size+this.pos[0],this.size+this.pos[1],this.size+this.pos[2]],[this.size+this.pos[0],this.size+this.pos[1],this.size+this.pos[2]]],this.faces=[[1,2,3,4],[5,1,4,8],[6,5,8,7],[2,6,7,3],[5,6,2,1],[4,3,7,8]]};CubeMesh.prototype=new Mesh;var Background=function(a){this.top=a.top,this.btm=a.btm,this.sky=a.sky,this.ground=a.ground,this.ctx=a.ctx,this.can=a.can},Renderer=function(a,b){this.fps=b.fps,this.interval=1/this.fps*1e3,this.maxWidth=b.maxWidth,this.maxHeight=b.maxHeight,this.centerX=b.maxWidth/2,this.centerY=b.maxHeight/2,this.ctx=b.ctx,this.texture=b.texture,this.bg=b.bg;var c=a,d=this;this.camera=c.cams[0],this.render=function(){queue.forEach(function(a){a(c,d)})}},queue=[r_transform,r_cam,r_scene,r_project,r_zsort,r_draw],Controller=function(a,b){this.init=function(){var a=b.camera,c=a.speed,d=a.friction;window.addEventListener("keydown",function(b){switch(b.keyCode){case 87:a.w=c;break;case 65:a.a=c;break;case 83:a.s=c;break;case 68:a.d=c;break;case 38:a.u=c;break;case 40:a.o=c;break;case 37:a.l=c;break;case 39:a.r=c}}),window.addEventListener("keyup",function(b){switch(b.keyCode){case 87:a.w-=d;break;case 65:a.a-=d;break;case 83:a.s-=d;break;case 68:a.d-=d;break;case 38:a.u=0;break;case 40:a.o=0;break;case 37:a.l=0;break;case 39:a.r=0}})}};